<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    ============================================================
    File Name  : AttendanceMapper.xml
    Description: 근태(Attendance) 관련 데이터를 조회하는 MyBatis 매퍼 XML

    History
    2025/12/09 (이지윤) 최초 작성 및 컨벤션 적용
    2025/12/10 (이지윤) 초과 근무(Overtime) 조회 쿼리 추가
    ============================================================
-->

<mapper namespace="com.c4.hero.domain.attendance.mapper.AttendanceMapper">

    <!-- ============================================================
         1) 개인 근태 기록 ResultMap
            PersonalDTO 매핑 정의
         ============================================================ -->
    <resultMap id="PersonalMap" type="com.c4.hero.domain.attendance.dto.PersonalDTO">
        <result property="attendanceId"   column="attendance_id"/>
        <result property="workDate"       column="work_date"/>
        <result property="state"          column="state"/>
        <result property="startTime"      column="start_time"/>
        <result property="endTime"        column="end_time"/>
        <result property="workDuration"   column="work_duration"/>
        <result property="workSystemName" column="work_system_name"/>
    </resultMap>

    <!-- ============================================================
         1-2) 초과 근무 기록 ResultMap
              OvertimeDTO 매핑 정의
         ============================================================ -->
    <resultMap id="OvertimeMap" type="com.c4.hero.domain.attendance.dto.OvertimeDTO">
        <result property="overtimeId"    column="overtime_id"/>
        <result property="date"          column="date"/>
        <result property="startTime"     column="start_time"/>
        <result property="endTime"       column="end_time"/>
        <result property="overtimeHours" column="overtime_hours"/>
        <result property="reason"        column="reason"/>
    </resultMap>

    <resultMap id="CorrectionMap" type="com.c4.hero.domain.attendance.dto.CorrectionDTO">
        <result property="correctionId" column="correction_request_id"/>
        <result property="date" column="target_date"/>
        <result property="prevStartTime" column="start_time"/>
        <result property="prevEndTime" column="end_time"/>
        <result property="reason" column="reason"/>
        <result property="newStartTime" column="corrected_start"/>
        <result property="newEndTime" column="corrected_end"/>
    </resultMap>

    <!-- ============================================================
         2) 개인 근태 기록 SELECT (페이지 조회)
            AttendanceMapper.selectPersonalPage(...)
         ============================================================ -->
    <select id="selectPersonalPage" resultMap="PersonalMap" parameterType="map">
        SELECT
        att.attendance_id,
        att.work_date,
        att.state,
        att.start_time,
        att.end_time,
        COALESCE(
        TIMESTAMPDIFF(MINUTE, att.start_time, att.end_time),
        0
        ) AS work_duration,
        wst.name AS work_system_name
        FROM tbl_attendance att
        JOIN tbl_work_system_type wst
        ON att.work_system_type_id = wst.work_system_type_id
        <where>
            <if test="startDate != null and startDate != ''">
                AND att.work_date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND att.work_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY att.work_date DESC, att.attendance_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ============================================================
         3) 개인 근태 기록 총 개수 조회
            AttendanceMapper.selectPersonalCount(...)
         ============================================================ -->
    <select id="selectPersonalCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_attendance att
        JOIN tbl_work_system_type wst
        ON att.work_system_type_id = wst.work_system_type_id
        <where>
            <if test="startDate != null and startDate != ''">
                AND att.work_date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND att.work_date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- ============================================================
         4) 초과 근무(Overtime) 기록 SELECT (페이지 조회)
            AttendanceMapper.selectOvertimePage(...)
         ============================================================ -->
    <select id="selectOvertimePage" resultMap="OvertimeMap" parameterType="map">
        SELECT
        ove.overtime_id,
        ove.date,
        ove.start_time,
        ove.end_time,
        ove.overtime_hours,
        ove.reason
        FROM tbl_overtime ove
        <where>
            <if test="startDate != null and startDate != ''">
                AND ove.date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND ove.date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY ove.date DESC, ove.overtime_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ============================================================
         5) 초과 근무(Overtime) 기록 총 개수 조회
            AttendanceMapper.selectOvertimeCount(...)
         ============================================================ -->
    <select id="selectOvertimeCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_overtime ove
        <where>
            <if test="startDate != null and startDate != ''">
                AND ove.date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND ove.date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <select id="selectCorrectionPage" resultMap="CorrectionMap" parameterType="map">
        SELECT
        cor.correction_request_id,
        cor.target_date,
        cor.corrected_start,
        cor.corrected_end,
        cor.reason,
        att.start_time,
        att.end_time
        FROM tbl_attendance_correction_request cor
        JOIN tbl_attendance att
        ON cor.attendance_id = att.attendance_id
        <where>
            <if test="startDate != null and startDate != ''">
                AND cor.target_date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND cor.target_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY cor.target_date DESC, cor.correction_request_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="selectCorrectionCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_attendance_correction_request cor
        JOIN tbl_attendance att
        ON cor.attendance_id = att.attendance_id
        <where>
            <if test="startDate != null and startDate != ''">
                AND cor.target_date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND cor.target_date &lt;= #{endDate}
            </if>
        </where>
    </select>

</mapper>
